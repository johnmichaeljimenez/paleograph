<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Paleograph</title>

	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.4/css/bulma.min.css">
	<link href="styles.css" rel="stylesheet">

	<script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
	<script type="module" src="/script.js"></script>
</head>

<body x-data="app" style="padding-top: 2rem;">
	<section class="section">
		<nav class="navbar has-shadow mb-4 is-fixed-top" role="navigation" aria-label="main navigation">
			<div class="navbar-brand">
				<a class="navbar-item has-text-weight-semibold">
					Paleograph
				</a>

				<a role="button" class="navbar-burger" :class="{ 'is-active': navOpen }" @click="navOpen = !navOpen"
					aria-label="menu" aria-expanded="false">
					<span aria-hidden="true"></span>
					<span aria-hidden="true"></span>
					<span aria-hidden="true"></span>
				</a>
			</div>

			<div class="navbar-menu" :class="{ 'is-active': navOpen }">

				<div class="navbar-start">
					<a class="navbar-item" @click="fileNew()">New</a>
					<a class="navbar-item" @click="fileOpen()">Open</a>
					<a class="navbar-item" @click="fileSave(false)">Save</a>
					<a class="navbar-item" @click="fileSave(true)">Save As</a>
				</div>

				<div class="navbar-end">
					<div class="navbar-item">
						<span class="has-text-grey">Project Tools</span>
					</div>
				</div>
			</div>
		</nav>

		<span x-text="fileHandle == null? '<Untitled>' : fileHandle.name"></span><br><br>

		<div class="tabs is-boxed is-medium">
			<ul>
				<li :class="{ 'is-active': tab === 'form' }">
					<a @click="tab = 'form'">Form</a>
				</li>
				<li :class="{ 'is-active': tab === 'report' }">
					<a @click="tab = 'report'">Report</a>
				</li>
				<li :class="{ 'is-active': tab === 'info' }">
					<a @click="tab = 'info'">Info</a>
				</li>
			</ul>
		</div>

		<div class="container" x-show="tab === 'form'">
			<form @submit.prevent="run">

				<div class="field">
					<label class="label is-medium">Target Directory</label>
					<div class="control">
						<input class="input is-medium" type="text" x-model="form.sourcePath" required>
					</div>
				</div>

				<div class="field">
					<label class="label is-medium">Custom Prompt</label>
					<div class="control">
						<textarea class="textarea is-medium" x-model="form.customPrompt"></textarea>
					</div>
				</div>

				<div class="field">
					<label class="label is-medium">Whitelist Extensions (pipe separated)</label>
					<div class="control">
						<input class="input is-medium" type="text" x-model="whitelistString">
					</div>
				</div>

				<div class="field">
					<label class="label is-medium">Blacklist Folders (pipe separated)</label>
					<div class="control">
						<input class="input is-medium" type="text" x-model="blacklistString">
					</div>
				</div>

				<div class="field">
					<div class="control">
						<label class="checkbox">
							<input type="checkbox" x-model="form.dryRun"> Dry Run
						</label>
					</div>
				</div>

				<div class="field">
					<div class="control">
						<button class="button is-primary" type="submit">Run</button>
					</div>
				</div>
			</form>
		</div>

		<div class="container" x-show="tab === 'report'">
			<div x-show="newData?.output?.textBlob?.length == 0">
				No Report available
			</div>

			<div x-show="newData?.output?.textBlob?.length > 0">
				Date: <span x-text="newData.output.dateGenerated"></span>
				<hr>
				<div x-html="renderedReport"></div>
			</div>
		</div>
		</div>

		<div class="container" x-show="tab === 'info'">
			<div x-show="newData?.output?.textBlob?.length == 0">
				No Report available
			</div>

			<div x-show="newData?.output?.textBlob?.length > 0">
				<div class="level">
					<div class="level-left">
						<div class="level-item">
							<span x-text="`Tokens: ${newData.output.tokenCount}`"></span>
						</div>
						<div class="level-item">
							<span x-show="newData.output.tokenCost > 0"
								x-text="`Cost: $${newData.output.tokenCost}`"></span>
						</div>
					</div>
					<div class="level-right">
						<div class="level-item">
							<button class="button is-small is-primary" @click="copyBlob()">Copy</button>
						</div>
					</div>
				</div>

				<pre><code x-text="newData.output.textBlob"></code></pre>
			</div>
		</div>

	</section>

	<div class="full-page-overlay" x-show="loading" x-transition>
		<div class="spinner-container">
			<div class="spinner"></div>
			<p class="has-text-white mt-4">Generating Report</p>
		</div>
	</div>

	<div style="position: fixed; top: 1rem; right: 1rem; z-index: 9999;" x-show="toast.show" x-transition x-cloak>
		<div class="notification" :class="{
            'is-success': toast.type === 'success',
            'is-danger': toast.type === 'error',
            'is-info': toast.type === 'info'
         }" @click="toast.show = false">
			<span x-text="toast.message"></span>
		</div>
	</div>
</body>

</html>